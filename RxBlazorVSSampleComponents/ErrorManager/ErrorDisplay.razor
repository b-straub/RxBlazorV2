@using System.Linq
@using MudBlazor
@using RxBlazorV2.Model
@inherits ErrorModelComponent

@if (Model.Messages.Count > 0)
{
    <MudStack Row="true" AlignItems="AlignItems.Center">
        <MudBadge Content="@Model.Messages.Count" Color="@GetBadgeColor()" Overlap="true" Class="d-flex align-center cursor-pointer" @onclick="ShowSnackbar">
            <MudIcon Icon="@GetIcon()" Color="@GetIconColor()" />
        </MudBadge>
        <MudIconButton Icon="@Icons.Material.Filled.Clear" OnClick="ClearMessages" Color="Color.Inherit" />
    </MudStack>
}

@code
{
    [Inject]
    public required ISnackbar Snackbar { get; init; }

    private Snackbar? _snackbar;

    protected override void OnMessagesChanged()
    {
        if (_snackbar is not null)
        {
            Snackbar.Remove(_snackbar);
            _snackbar = null;
        }

        if (Model.Messages.Count > 0)
        {
            var latestMessage = Model.Messages[^1];
            var messageText = latestMessage.Source is not null
                ? $"{latestMessage.Message} ({latestMessage.Source})"
                : latestMessage.Message;

            if (Model.Messages.Count == 1)
            {
                _snackbar = Snackbar.Add(messageText, ToMudSeverity(latestMessage.Severity));
            }
            else
            {
                var groupedMessages = Model.Messages
                    .GroupBy(m => m.Severity)
                    .OrderByDescending(g => g.Key)
                    .SelectMany(g => g.Select(m => m.Source is not null ? $"{m.Message} ({m.Source})" : m.Message));

                var messageHtml = new MarkupString("<ul class=\"pl-4 ma-0\">" +
                    string.Join("", groupedMessages.Select(m => $"<li>{m}</li>")) + "</ul>");

                var highestSeverity = Model.Messages.Max(m => m.Severity);
                _snackbar = Snackbar.Add(messageHtml, ToMudSeverity(highestSeverity));
            }
        }
    }

    private void ShowSnackbar()
    {
        OnMessagesChanged();
    }

    private void ClearMessages()
    {
        Model.ClearMessages();
    }

    private Color GetBadgeColor()
    {
        if (Model.Messages.Any(m => m.Severity == StatusSeverity.Error))
        {
            return Color.Error;
        }
        if (Model.Messages.Any(m => m.Severity == StatusSeverity.Warning))
        {
            return Color.Warning;
        }
        if (Model.Messages.Any(m => m.Severity == StatusSeverity.Success))
        {
            return Color.Success;
        }
        return Color.Info;
    }

    private Color GetIconColor() => GetBadgeColor();

    private string GetIcon()
    {
        if (Model.Messages.Any(m => m.Severity == StatusSeverity.Error))
        {
            return Icons.Material.Filled.Error;
        }
        if (Model.Messages.Any(m => m.Severity == StatusSeverity.Warning))
        {
            return Icons.Material.Filled.Warning;
        }
        if (Model.Messages.Any(m => m.Severity == StatusSeverity.Success))
        {
            return Icons.Material.Filled.CheckCircle;
        }
        return Icons.Material.Filled.Info;
    }

    private static Severity ToMudSeverity(StatusSeverity severity) => severity switch
    {
        StatusSeverity.Error => Severity.Error,
        StatusSeverity.Warning => Severity.Warning,
        StatusSeverity.Success => Severity.Success,
        _ => Severity.Info
    };
}
